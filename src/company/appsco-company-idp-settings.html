<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">

<link rel="import" href="../components/components/appsco-loader.html">
<link rel="import" href="../components/components/appsco-form-error.html">
<link rel="import" href="appsco-company-idp-settings-saml-form.html">
<link rel="import" href="appsco-company-idp-settings-openid-form.html">

<dom-module id="appsco-company-idp-settings">
    <template>
        <style>
            :host {
                display: block;
                position: relative;

                --paper-dropdown-menu: {
                    display: block;
                };
            }
            :host .submit-button {
                margin: 20px 0 0 0;
                @apply(--form-action);
            }
            :host neon-animated-pages > .iron-selected {
                position: relative;
            }
        </style>

        <iron-ajax auto
                   url="[[ idPIntegrationsApi ]]"
                   headers="[[ _headers ]]"
                   handle-as="json"
                   on-error="_onIdPIntegrationsError"
                   on-response="_onIdPIntegrationsResponse"></iron-ajax>

        <iron-ajax id="getDomainIdPConfig"
                   url="[[ domain.meta.idpConfig ]]"
                   headers="[[ _headers ]]"
                   handle-as="json"
                   on-response="_onIdPConfigResponse"></iron-ajax>

        <appsco-loader active="[[ _loader ]]" loader-alt="AppsCo is processing request" multi-color></appsco-loader>

        <appsco-form-error message="[[ _error ]]"></appsco-form-error>

        <paper-input id="title"
                     label="Title"
                     data-field
                     name="[[ _formPrefix ]][title]"
                     value="[[ _idPConfig.name ]]"
                     required
                     error-message="Please type in title."
                     on-keyup="_onKeyUp"></paper-input>

        <paper-input id="domain"
                     label="Domain"
                     always-float-label
                     value="[[ domain.domain ]]"
                     disabled></paper-input>

        <paper-input label="Domain"
                     data-field
                     name="[[ _formPrefix ]][companyDomains][0]"
                     value="[[ domain.self ]]"
                     hidden></paper-input>

        <paper-dropdown-menu id="integrationType"
                             label="Integration type"
                             always-float-label$="[[ domain.hasIdp ]]"
                             horizontal-align="left"
                             required
                             error-message="Please select integration type."
                             disabled$="[[ domain.hasIdp ]]">
            <paper-listbox id="integrationList"
                           class="dropdown-content"
                           attr-for-selected="value"
                           selected="[[ _idPConfig.integrationId ]]"
                           on-selected-changed="_onIntegrationTypeSelect">
                <template is="dom-repeat" items="[[ _integrations ]]">
                    <paper-item value="[[ item.id ]]"
                                integration-id="[[ item.id ]]">[[ item.name ]]</paper-item>
                </template>
            </paper-listbox>
        </paper-dropdown-menu>

        <neon-animated-pages
                selected="[[ _activeForm ]]"
                attr-for-selected="name"
                entry-animation="scale-up-animation"
                exit-animation="scale-down-animation"
                on-neon-animation-finish="_onPageAnimationFinish">

            <appsco-company-idp-settings-saml-form
                    name="saml"
                    data-form
                    id-p-config="[[ _idPConfig ]]"
                    form-prefix="[[ _formPrefix ]]"></appsco-company-idp-settings-saml-form>

            <appsco-company-idp-settings-openid-form
                    name="openid"
                    data-form
                    id-p-config="[[ _idPConfig ]]"
                    integration="[[ _selectedIntegration ]]"
                    form-prefix="[[ _formPrefix ]]"></appsco-company-idp-settings-openid-form>
        </neon-animated-pages>

        <paper-button id="submit"
                      class="submit-button"
                      on-tap="_submitForm">Save</paper-button>

        <iron-a11y-keys keys="enter"
                        on-keys-pressed="_onEnter"></iron-a11y-keys>

    </template>
    <script>
        Polymer({

            is: 'appsco-company-idp-settings',

            properties: {

                company: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                domain: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    observer: '_onDomainChanged'
                },

                /**
                 * Authorization token.
                 */
                authorizationToken: {
                    type: String,
                    value: ''
                },

                idPIntegrationsApi: {
                    type: String
                },

                apiErrors: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                _settingsApi: {
                    type: String
                },

                _idPConfig: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                /**
                 * Computed headers.
                 * It contains authorization token.
                 */
                _headers: {
                    type: Object,
                    computed: '_computeHeaders(authorizationToken)'
                },

                _integrations: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                },

                _selectedIntegration: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    observer: '_onSelectedIntegrationChanged'
                },

                _loader: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Error message for settings form.
                 */
                _error: {
                    type: String
                },

                _activeForm: {
                    type: String,
                    value: ''
                },

                _formPrefix: {
                    type: String,
                    computed: '_computeFormPrefix(_activeForm)'
                }
            },

            listeners: {
                'show-error': '_showError',
                'hide-error': '_hideError'
            },

            attached: function() {
                this._clearForm();
            },

            setup: function() {
                this.$.title.focus();
            },

            reset: function() {
                this._clearForm();
                this._hideError();
                this._hideLoader();
                Polymer.dom(this.root).querySelector('[data-form]').reset();
                this.set('_idPConfig', {});
                this.set('domain', {});
                this.set('_selectedIntegration', {});
                this._activeForm = '';
            },

            setDomain: function(domain) {
                this.set('domain', domain);
            },

            _computeHeaders: function (authorizationToken) {
                return {
                    'Authorization': 'token ' + authorizationToken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            },

            _computeIdPIntegrationsApi: function(settingsApi) {
                return settingsApi ? (settingsApi + '/integrations') : null;
            },

            _computeFormPrefix: function(activeForm) {

                switch (activeForm) {

                    case 'openid':
                        return 'open_id_config';

                    default:
                        return 'saml_idp_config';
                }
            },

            _showLoader: function() {
                this._loader = true;
            },

            _hideLoader: function() {
                this._loader = false;
            },

            _showError: function(message) {
                this._error = ('string' === typeof message) ?
                    message :
                    ((message.detail && message.detail.message) ?
                        message.detail.message :
                        this.apiErrors.getError(404));
            },

            _hideError: function() {
                this._error = '';
            },

            _clearForm: function() {

                Polymer.dom(this.root).querySelectorAll('[data-field]').forEach(function(item) {
                    var inputContainer = item.$$('#container');

                    item.value = '';
                    item.invalid = false;

                    // Used because gold-cc-input doesn't send 'invalid' property down to children elements
                    if (inputContainer) {
                        inputContainer.invalid = false;
                    }
                }.bind(this));
            },

            _onDomainChanged: function(domain) {

                if (domain && domain.meta && domain.meta.idpConfig) {
                    this.$.getDomainIdPConfig.generateRequest();
                }
            },

            _onKeyUp: function(event) {

                if (13 !== event.keyCode) {
                    this._hideError();
                    event.target.invalid = false;
                }
            },

            _onSelectedIntegrationChanged: function(integration) {

                for (var key in integration) {
                    this._activeForm = integration.kind.toLowerCase();
                    this._settingsApi = integration.meta.create;
                    return false;
                }

                this._activeForm = '';
            },

            _onIntegrationTypeSelect: function(event) {
                var currentTarget = event.currentTarget;

                this._hideError();
                this.$.integrationType.invalid = false;

                setTimeout(function() {
                    var integrationID = currentTarget.selectedItem ? currentTarget.selectedItem.integrationId : '',
                        integrations = this._integrations;

                    integrations.forEach(function(item) {

                        if (integrationID === item.id) {
                            this.set('_selectedIntegration', item);
                            return false;
                        }
                    }.bind(this));
                }.bind(this), 30);

            },

            _onIdPIntegrationsError: function() {
                this.set('_integrations', []);
            },

            _onIdPIntegrationsResponse: function(event) {
                var response = event.detail.response;

                if (response && response.integrations) {
                    this.set('_integrations', response.integrations);
                }

            },

            _onIdPConfigResponse: function(event) {
                var response = event.detail.response;

                if (response) {
                    this.set('_idPConfig', {});
                    this.set('_idPConfig', response[0]);
                }

            },

            _onPageAnimationFinish: function(event) {
                var fromPage = event.detail.fromPage;

                if (!this.domain.hasIdp && fromPage.$ && ('undefined' !== typeof fromPage.reset)) {
                    fromPage.reset();
                }
            },

            _onEnter: function() {
                this._submitForm();
            },

            _validateForm: function() {
                var valid = true;

                Polymer.dom(this.root).querySelectorAll('[data-field]').forEach(function(item) {
                    item.validate();
                    valid = valid && !item.invalid;
                }.bind());

                return valid;
            },

            _getEncodedBodyValues: function(form) {
                var body = '';

                Polymer.dom(this.root).querySelectorAll('[data-field]').forEach(function(item) {

                    if (item.value) {
                        body += ('' === body) ? '' : '&';
                        body += encodeURIComponent(item.name) + '=' + encodeURIComponent(item.value);
                    }
                }.bind(this));

                body += ('' === body) ? '' : '&';
                body += form.getEncodedBodyValues();

                return body;
            },

            _submitForm: function() {

                if (!this._activeForm) {
                    this.$.integrationType.invalid = true;
                    return false;
                }

                var form = Polymer.dom(this.root).querySelector('[name="' + this._activeForm +'"]');

                if (this._validateForm() && form.validate()) {

                    if (form.getCertificates) {
                        var certificates = form.getCertificates();

                        if (!certificates || 0 === certificates.length) {
                            this._showError('Please add at least one certificate.');
                            return;
                        }
                    }

                    this._showLoader();

                    this._save(form).then(function(response) {
                        var config = response[0];

                        this.domain.hasIdp = true;
                        this.domain.meta.idpConfig = config.self;

                        this.fire('idp-settings-saved', {
                            domain: this.domain,
                            idPConfig: config
                        });

                        this._hideLoader();
                    }.bind(this), function(code) {
                        this._showError(this.apiErrors.getError(code));
                        this._hideLoader();
                    }.bind(this));
                }
            },

            _save: function(form) {
                return new Promise(function(resolve, reject) {
                    var request = document.createElement('iron-request'),
                        options = {
                            url: this._settingsApi,
                            method: 'POST',
                            handleAs: 'json',
                            headers: this._headers,
                            body: this._getEncodedBodyValues(form)
                        };

                    if (this.domain.hasIdp) {
                        options.url = this.domain.meta.idpConfig;
                        options.method = 'PUT';
                    }
                    else {
                        options.body += ('&' + this._formPrefix +'[integrationId]=' + encodeURIComponent(this.$.integrationList.selectedItem.value));
                    }

                    request.send(options).then(function() {

                        if (200 === request.status) {
                            resolve(request.response);
                        }

                    }.bind(this), function() {
                        reject(request.response.code);
                    }.bind(this));
                }.bind(this));
            }
        });
    </script>
</dom-module>
